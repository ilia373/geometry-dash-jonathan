rules_version = '2';

/**
 * Firestore Security Rules for Geometry Dash
 * 
 * SECURITY MODEL:
 * - Users can only read/write their own documents
 * - Admin status is verified via custom claims (set by Cloud Function)
 * - Custom claims are cryptographically signed and cannot be forged
 * 
 * The admin claim is set server-side by the setAdminClaim blocking function
 * and is included in the user's ID token (JWT).
 */
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    // This checks the custom claim set by the Cloud Function
    // The claim is cryptographically signed and cannot be forged client-side
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // User documents - users can only access their own data
    match /users/{userId} {
      // Users can read their own document
      allow read: if isOwner(userId);
      
      // Users can write their own document with validation
      allow write: if isOwner(userId)
        // Validate data structure
        && request.resource.data.keys().hasOnly([
          'coins', 'completedLevels', 'bestProgress', 
          'selectedSkin', 'ownedSkins', 'lastUpdated'
        ])
        // Coins must be a non-negative number (prevent cheating)
        && request.resource.data.coins is number
        && request.resource.data.coins >= 0
        // Timestamp must be present
        && request.resource.data.lastUpdated is number;
    }
    
    // Admin-only collection for game configuration (future use)
    match /config/{document} {
      // Anyone can read config
      allow read: if isAuthenticated();
      // Only admins can write config
      allow write: if isAdmin();
    }
    
    // Admin-only collection for analytics/logs (future use)
    match /adminData/{document} {
      // Only admins can read/write
      allow read, write: if isAdmin();
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
